From f9478f8c29fa3545d627d2726bed6115d229dc5d Mon Sep 17 00:00:00 2001
From: Carlos Soriano <csoriano2718@users.noreply.github.com>
Date: Fri, 21 Nov 2025 23:11:24 +0100
Subject: [PATCH] fix(llama.cpp): Add reasoning flags when --thinking is
 enabled

Add --reasoning-format and --reasoning-budget flags to llama.cpp
inference spec when args.thinking is true:
- --reasoning-format auto: Auto-detect model's reasoning format
- --reasoning-budget -1: Unlimited reasoning budget

Keep existing behavior when args.thinking is false:
- --reasoning-budget 0: Disable reasoning (default)

This allows reasoning models (deepseek-r1, qwq, etc.) to generate
reasoning content when --thinking flag is used. Previously, even
when --thinking was enabled, reasoning-budget was always 0.

Tested with:
- deepseek-r1:14b + --thinking true: reasoning works
- llama3.2 + --thinking false: reasoning disabled

Assisted-by: Cursor with Claude Sonnet 4.5
---
 inference-spec/engines/llama.cpp.yaml | 10 +++++++++-
 1 file changed, 9 insertions(+), 1 deletion(-)

diff --git a/inference-spec/engines/llama.cpp.yaml b/inference-spec/engines/llama.cpp.yaml
index 19d84cb2..81e0ceaa 100644
--- a/inference-spec/engines/llama.cpp.yaml
+++ b/inference-spec/engines/llama.cpp.yaml
@@ -32,8 +32,16 @@ commands:
           if: "{{ not model.mmproj_path }}"
         - name: "--no-warmup"
           description: "Flag to disable empty run for warm up"
+        - name: "--reasoning-format"
+          description: "Format for reasoning content (auto = detect from model)"
+          value: "auto"
+          if: "{{ args.thinking }}"
         - name: "--reasoning-budget"
-          description: "Controls the amount of thinking allowed"
+          description: "Reasoning budget for thinking (-1 = unlimited, 0 = disabled)"
+          value: "-1"
+          if: "{{ args.thinking }}"
+        - name: "--reasoning-budget"
+          description: "Disable reasoning when not requested"
           value: "0"
           if: "{{ not args.thinking }}"
         - name: "--alias"
-- 
2.51.1

