From 06de605f8d3cf2057bea4a14fad8cad42ccf4f02 Mon Sep 17 00:00:00 2001
From: Carlos Soriano <csoriano2718@users.noreply.github.com>
Date: Fri, 21 Nov 2025 23:11:24 +0100
Subject: [PATCH] fix(llama.cpp): Add reasoning-format flag for proper
 reasoning support

- Add --reasoning-format auto when args.thinking is enabled
- Add --reasoning-budget -1 when args.thinking is enabled
- Keep --reasoning-budget 0 when args.thinking is disabled (existing behavior)

This allows reasoning models to work correctly when --thinking flag is
passed, while preserving the ability to disable reasoning (default).

Previously, --reasoning-budget was always 0 (disabled) even when
--thinking was requested. Now the flag properly enables reasoning with
auto-detection when explicitly requested via --thinking.

No change to default behavior: reasoning remains disabled unless
--thinking flag is used.
---
 inference-spec/engines/llama.cpp.yaml | 10 +++++++++-
 1 file changed, 9 insertions(+), 1 deletion(-)

diff --git a/inference-spec/engines/llama.cpp.yaml b/inference-spec/engines/llama.cpp.yaml
index 19d84cb2..81e0ceaa 100644
--- a/inference-spec/engines/llama.cpp.yaml
+++ b/inference-spec/engines/llama.cpp.yaml
@@ -32,8 +32,16 @@ commands:
           if: "{{ not model.mmproj_path }}"
         - name: "--no-warmup"
           description: "Flag to disable empty run for warm up"
+        - name: "--reasoning-format"
+          description: "Format for reasoning content (auto = detect from model)"
+          value: "auto"
+          if: "{{ args.thinking }}"
         - name: "--reasoning-budget"
-          description: "Controls the amount of thinking allowed"
+          description: "Reasoning budget for thinking (-1 = unlimited, 0 = disabled)"
+          value: "-1"
+          if: "{{ args.thinking }}"
+        - name: "--reasoning-budget"
+          description: "Disable reasoning when not requested"
           value: "0"
           if: "{{ not args.thinking }}"
         - name: "--alias"
-- 
2.51.1

